# Figures

(ref:figure1) Sample locations from the 2016 WCVI, 2016 WCHG research surveys and 2017 pilot study.  The sample locations of the salmon survey are unknown.

```{r figure1, fig.cap='(ref:figure1)',warning=FALSE, echo=FALSE, message=FALSE, error= FALSE, width=5.9, height=8.5, fig.align='center'}

    library(here)
    library(rgdal)
    library(ggfortify)

    png("C:/github/sablehead/figures/Figure1.png", units="px", width=1600, height=1800, res=150) # write png to file
    sql          <-   "select * from Head_Measurements_Report where SLAT > 0"  # head measurement data
    #pointdata    <-   GetSQLData(sql,"Sablefish")   # retrieve from seamount database
    #write.table(pointdata, file = paste(path,"figure1.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
    #pointdata    <-  read.csv(paste(path,'figure1.csv',sep=''),header=T)  # read from csv
    
    #K.Holt: changed point data to use here function when reading
    #pointdata    <-read.csv(here("standalone", "figure1.csv"))
    pointdata    <-  read.csv(paste(path,'figure1.csv',sep=''),header=T)  # read from csv
    
    lon          <-   data.frame(pointdata$SLAT)
    lat          <-   data.frame(pointdata$SLON)
    spid         <-   data.frame(pointdata$SPECIMEN_ID)
    trip         <-   data.frame(pointdata$TRIP_ID)
    df           <-   as.data.frame(cbind(lon,lat,spid,trip))   # add year, lat, long, specimen_id to dataframe

    # add pilot survey coordinates for general fishing area
    a <- c(46.7093,-130.82812, 1, 338773 ) #  cobb
    b <- c(48.2828,-133.204, 2, 338773 )    #   eickelburg
    
    df           <-  rbind(df,a)
    df           <-  rbind(df,b)
    df           <-  df[df$pointdata.TRIP_ID !=0,]
   
    canada       <-   readOGR(dsn = "C:/github/sablehead/storage",layer ="awscntry_geo", verbose = FALSE)  # open shapefile   
    shapef_can   <-   fortify(canada)    # fortify for ggplot require.
    points_df    <-   fortify(df)
    
    seamounts    <-   readOGR(dsn = "C:/github/sablehead/storage",layer ="twoSeamounts_geo", verbose = FALSE)  # open shapefile
    seam_can     <-   fortify(seamounts)    # fortify for ggplot require.
    
    map          <-  ggplot() +
                     geom_polygon(data = shapef_can,  
                                  aes(x = long, y = lat, group = group), 
                                      fill="gray40",  
                                      size = .2) +
                     geom_polygon(data = seam_can, aes(x = long, y =  lat, group = group), 
                                  color = "lightgray", alpha = 0, linetype = 1)  +
                     geom_point(data =   points_df, aes(pointdata.SLON, pointdata.SLAT,  
                                                    fill=factor(pointdata.TRIP_ID),  size=0.7) , 
                                                          colour="lightgray", shape=21, size=5) + 
                     geom_text(aes(x =  -130.000, y = 46.7093, label = "Cobb"),
                                    alpha = 1,
                                    color = "grey40")  +
                     geom_text(aes(x =  -131.6040, y = 48.2828, label = "Eickelberg"),
                                    alpha = 1,
                                    color = "grey40")  +
                     theme_minimal()    +
                     guides(fill="none") + 
                     guides(size="none") + 
                     guides(fill=guide_legend(title="Trip")) +
                     xlab("Longitude") + ylab("Latitude") + 
                     theme(  text = element_text(size=20),
                             plot.title      = element_blank(),
                             legend.position = c(.29, 0.45),
                             legend.justification = c("right", "top"),
                             legend.box.just = "right",
                             legend.margin = margin(6, 6, 6, 6)
                          )   
   
    map_projected  <- map +   # reproject to make it look better
    coord_map()  +
    annotation_north_arrow(location = "bl", which_north = "true",  # north arrow
                           pad_x  = unit(1.0, "cm"),  
                           pad_y  = unit(2.5,  "cm"),
                           height = unit(2.5,  "cm"),
                          width  = unit(2.5,  "cm"),
                           style  = north_arrow_fancy_orienteering)
    
    map_projected        +
    annotation_scale(location = "bl",
                     pad_x = unit(0.5, "in"),  
                     pad_y = unit(0.3, "in"),
                     height = unit(0.5, "cm"),
                     width  = unit(5.95,"cm"),
                     text_cex = 1.0)   +
                     coord_sf(crs = 4326)  +
                     scale_fill_discrete(name = "Research Trip", 
                                         labels = c("WCVI", "WCHG","Seamount Pilot"))

    while (!is.null(dev.list()))  dev.off()
    img <-   paste('C:/github/sablehead/figures/Figure1.png',sep="")   # -- retrieve png 
            knitr::include_graphics(img)
 
```

```{r figure_data_fit_regression_male_female}
  
  #  fit the regression lines and get the prediction results separately for male, female and head measurements
  #  before putting in ggplot - very necessary 
     
     cranial.f                     <-  hdUj[hdUj$SPECIMEN_SEX_DESC=="FEMALE",]  # Upper jaw  length data
     cranial.f$n                   <-  length(cranial.f$HeadBarcode)                   # number of specimens 
     cranial.fit.outliers.f        <-  lm(Fork_Length ~ Upper_jaw_length, data=cranial.f)  # linear regression model         
     #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.f  <-  summary(cranial.fit.outliers.f)                 # summary

     cranial.f$predicted           <-  predict(cranial.fit.outliers.f)   # save the predicted values
     cranial.f$residuals           <-  residuals(cranial.fit.outliers.f) # save the residual values

     cranial.m                     <-  hdUj[hdUj$SPECIMEN_SEX_DESC=="MALE",]  # data
     cranial.m$n                   <-  length(cranial.m$HeadBarcode)                   # number of specimens 
     cranial.fit.outliers.m        <-  lm(Fork_Length ~ Upper_jaw_length, data=cranial.m)  # linear regression model 
     #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.m  <-  summary(cranial.fit.outliers.m)                 # summary

     cranial.m$predicted           <-  predict(cranial.fit.outliers.m)   # save the predicted values
     cranial.m$residuals           <-  residuals(cranial.fit.outliers.m) # save the residual values

     cranial.uj  <-  rbind( cranial.f, cranial.m )
     names(cranial.uj)[6] <- "hlength" 

     cranial.f                     <-  hdEd[hdEd$SPECIMEN_SEX_DESC=="FEMALE",]  # Eye Diameter length data
     cranial.f$n                   <-  length(cranial.f$HeadBarcode)                   # number of specimens 
     cranial.fit.outliers.f        <-  lm(Fork_Length ~ Eye_Diameter, data=cranial.f)  # linear regression model 
     #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.f  <-  summary(cranial.fit.outliers.f)                 # summary

     cranial.f$predicted           <-  predict(cranial.fit.outliers.f)   # save the predicted values
     cranial.f$residuals           <-  residuals(cranial.fit.outliers.f) # save the residual values

     cranial.m                     <-  hdEd[hdEd$SPECIMEN_SEX_DESC=="MALE",]  
     cranial.m$n                   <-  length(cranial.m$HeadBarcode)                   # number of specimens 
     cranial.fit.outliers.m        <-  lm(Fork_Length ~ Eye_Diameter, data=cranial.m)  # linear regression model 
     #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.m  <-  summary(cranial.fit.outliers.m)                 # summary

     cranial.m$predicted           <-  predict(cranial.fit.outliers.m)   # save the predicted values
     cranial.m$residuals           <-  residuals(cranial.fit.outliers.m) # save the residual values

     cranial.ed  <-  rbind( cranial.f, cranial.m )
     names(cranial.ed)[6] <- "hlength"

     cranial.f                     <-  hdId[hdId$SPECIMEN_SEX_DESC=="FEMALE",]  # InterOrbital distance data
     cranial.f$n                   <-  length(cranial.f$HeadBarcode)                   # number of specimens 
     cranial.fit.outliers.f        <-  lm(Fork_Length ~ InterOrbital_Distance, data=cranial.f)  # linear regression model 
     #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.f  <-  summary(cranial.fit.outliers.f)                 # summary

     cranial.f$predicted           <-  predict(cranial.fit.outliers.f)   # save the predicted values
     cranial.f$residuals           <-  residuals(cranial.fit.outliers.f) # save the residual values

     cranial.m                     <-  hdId[hdId$SPECIMEN_SEX_DESC=="MALE",]  
     cranial.m$n                   <-  length(cranial.m$HeadBarcode)                   # number of specimens 
     cranial.fit.outliers.m        <-  lm(Fork_Length ~ InterOrbital_Distance, data=cranial.m)  # linear regression model 
     #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.m  <-  summary(cranial.fit.outliers.m)                 # summary

     cranial.m$predicted           <-  predict(cranial.fit.outliers.m)   # save the predicted values
     cranial.m$residuals           <-  residuals(cranial.fit.outliers.m) # save the residual values

     cranial.id  <-  rbind( cranial.f, cranial.m )
     names(cranial.id)[6] <- "hlength"

     cranial.f                     <-  hdSl[hdSl$SPECIMEN_SEX_DESC=="FEMALE",]         # Snout length data
     cranial.f$n                   <-  length(cranial.f$HeadBarcode)                   # number of specimens 
     cranial.fit.outliers.f        <-  lm(Fork_Length ~ Snout_length, data=cranial.f)  # linear regression model 
     #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.f  <-  summary(cranial.fit.outliers.f)                 # summary

     cranial.f$predicted           <-  predict(cranial.fit.outliers.f)   # save the predicted values
     cranial.f$residuals           <-  residuals(cranial.fit.outliers.f) # save the residual values

     cranial.m                     <-  hdSl[hdSl$SPECIMEN_SEX_DESC=="MALE",]  
     cranial.m$n                   <-  length(cranial.m$HeadBarcode)                   # number of specimens 
     cranial.fit.outliers.m        <-  lm(Fork_Length ~ Snout_length, data=cranial.m)  # linear regression model 
     #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.m  <-  summary(cranial.fit.outliers.m)                 # summary

     cranial.m$predicted           <-  predict(cranial.fit.outliers.m)   # save the predicted values
     cranial.m$residuals           <-  residuals(cranial.fit.outliers.m) # save the residual values

     cranial.sl <-  rbind( cranial.f, cranial.m )
     names(cranial.sl)[6] <- "hlength"
     
     cranial.f                     <-  hdPop[hdPop$SPECIMEN_SEX_DESC=="FEMALE",]  # Postorbital_Preoperculum length data
     cranial.f$n                   <-  length(cranial.f$HeadBarcode)              # number of specimens 
     cranial.fit.outliers.f        <-  lm(Fork_Length ~ Postorbital_Preoperculum, data=cranial.f)  # linear regression model #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.f  <-  summary(cranial.fit.outliers.f)         # summary

     cranial.f$predicted           <-  predict(cranial.fit.outliers.f)   # save the predicted values
     cranial.f$residuals           <-  residuals(cranial.fit.outliers.f) # save the residual values

     cranial.m                     <-  hdPop[hdPop$SPECIMEN_SEX_DESC=="MALE",]  # snout length data
     cranial.m$n                   <-  length(cranial.m$HeadBarcode)                   # number of specimens 
     cranial.fit.outliers.m        <-  lm(Fork_Length ~ Postorbital_Preoperculum, data=cranial.m)  # linear regression model #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.m  <-  summary(cranial.fit.outliers.m)         # summary

     cranial.m$predicted           <-  predict(cranial.fit.outliers.m)   # save the predicted values
     cranial.m$residuals           <-  residuals(cranial.fit.outliers.m) # save the residual values

     cranial.pp <-  rbind( cranial.f, cranial.m )
     names(cranial.pp)[6] <- "hlength"

     cranial.f                     <-  hdPo[hdPo$SPECIMEN_SEX_DESC=="FEMALE",]  # Post orbital Head length data
     cranial.f$n                   <-  length(cranial.f$HeadBarcode)              # number of specimens 
     cranial.fit.outliers.f        <-  lm(Fork_Length ~ Post_orbital_Head_length, data=cranial.f)  # linear regression model #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.f  <-  summary(cranial.fit.outliers.f)         # summary

     cranial.f$predicted           <-  predict(cranial.fit.outliers.f)   # save the predicted values
     cranial.f$residuals           <-  residuals(cranial.fit.outliers.f) # save the residual values

     cranial.m                     <-  hdPo[hdPo$SPECIMEN_SEX_DESC=="MALE",]  
     cranial.m$n                   <-  length(cranial.m$HeadBarcode)                   # number of specimens 
     cranial.fit.outliers.m        <-  lm(Fork_Length ~ Post_orbital_Head_length, data=cranial.m)  # linear regression model #plot(hd.fit.outliers, which = 1, pch=21) 
     cranial.fit.outliersummary.m  <-  summary(cranial.fit.outliers.m)         # summary

     cranial.m$predicted           <-  predict(cranial.fit.outliers.m)   # save the predicted values
     cranial.m$residuals           <-  residuals(cranial.fit.outliers.m) # save the residual values

     cranial.po <-  rbind( cranial.f, cranial.m )
     names(cranial.po)[6] <- "hlength"

   
```
(ref:figure2) Relationship between cranial lengths (UJ-upper jaw, ED-eye diameter, ID-interorbital distance) vs fork length in millimeters.  Predicted points represented by black circles, measured values colored by residual scale.

```{r figure2, fig.cap='(ref:figure2)', results='asis', out.width = "470px", fig.align='left'}
   
     png("C:/github/sablehead/figures/Figure2.png", units="px", 
         width=2300, height=2700, res=500) # write png to file

     library(viridis)
     
     cranial       <- rbind(cranial.uj,cranial.ed, cranial.id)  # facet wrap all 5 cranial measurements
     cranial$facet <- factor(cranial$measure, levels = c("UJ", "ED", "ID"))

     ggplot(cranial, aes(x = hlength, y = Fork_Length)) +
            scale_y_continuous(limits = c(200, 1200)) +
            ylab('Fork length (mm)') +
            xlab("Cranial dimension (mm)") + 
            geom_smooth(method = "lm",se = FALSE,color = "grey") +                          # plot regression slope
            geom_segment(aes(xend = hlength, yend = predicted), color= "black", size=0.15, alpha = .35) +  # lines
                              # color residuals https://drsimonj.svbtle.com/visualising-residuals
            geom_point(aes(color = abs(residuals), size = abs(residuals))) +                # residuals
            scale_size(range=c(0.1,0.9)) + 
            scale_color_gradient2(low = "grey", mid = "#1ebecd", high = "orange")  +   
            guides( size = FALSE) +
       
            geom_point(aes(y = predicted), shape = 20, size=0.25)     +    # plot predicted circles
       
                stat_regline_equation(label.x=85, label.y=450, aes(label = ..eq.label..), size=2.1, 
                                      label.x.npc = "right",
                                      label.y.npc = "bottom") +   # y = mx+b and r2 values added to plot
       
                stat_regline_equation(label.x=85, label.y = 350,  aes(label = ..rr.label..), size=2.1,
                                      label.x.npc = "right",
                                      label.y.npc = "bottom") +  # r square value
       
                stat_cor( aes(label = paste(
                      if_else(readr::parse_number(..p.label..) < 0.001,    # p value
                              "p<0.001", ..p.label..), sep = "~`,   `~")),
                               label.x=85,
                               label.y = 250, size=2.1,
                               label.x.npc = "right",
                               label.y.npc = "bottom")  +
                geom_text(size=2.0, aes(x=20,y=1140,label= paste0("n=",n)))  +
                
                facet_grid( facet ~ SPECIMEN_SEX_DESC) +   # facet wrap
       
                theme(legend.position=c(0.87,0.56),legend.key.size = unit(1.4, 'mm'),    # legend position
                      legend.text=element_text(size=6), legend.title = element_text(size=6)) +
                theme(legend.box = 'horizontal')  + 
                labs(color="residuals") + 
                      theme(strip.text.x = element_text(size=7),
                      strip.text.y = element_text(size=7),
                      strip.background = element_rect(size=0.25,colour="black", fill="lightgray")) +
                      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.25)) +
                      theme(axis.title.y = element_text(size = 7), axis.title.x = element_text(size = 7) ) +
                      theme(axis.text = element_text(size = 6)) +
                      theme(panel.background = element_rect(fill = "white",
                                colour = "white",
                                size = 0.35, linetype = "solid"),  # control the grey lines
                                panel.grid.major = element_line(size = 0.125, linetype = 'solid',
                                colour = "grey"), 
                                panel.grid.minor = element_line(size = 0.125, linetype = 'solid',
                                colour = "grey"))

     while (!is.null(dev.list()))  dev.off()
     img <-   paste('C:/github/sablehead/figures/figure2.png',sep="")   # -- retrieve png 
              knitr::include_graphics(img)
     
```

(ref:figure3) Relationship between cranial lengths (SL-snout length, PP-post orbital to preoperculum, PO-post orbital) vs fork length in millimeters.    Predicted points represented by black circles, measured values colored by residual scale.

```{r figure3, fig.cap='(ref:figure3)', results='asis',  out.width = "470px", fig.align='left'}
   
     png("C:/github/sablehead/figures/Figure3.png", units="px", width=2300, height=2700, res=500) # write png to file
      
     cranial <- rbind(cranial.sl, cranial.pp, cranial.po)  # facet wrap all 3 cranial measurements
     cranial$facet = factor(cranial$measure, levels = c("SL","PP","PO"))
 
     ggplot(cranial, aes(x = hlength, y = Fork_Length)) +
            scale_y_continuous(limits = c(200, 1200)) +
            ylab('Fork length (mm)') +
            xlab("Cranial dimension (mm)") + 
            geom_smooth(method = "lm",se = FALSE,color = "grey") +                          # plot regression slope
            geom_segment(aes(xend = hlength, yend = predicted), color= "black", size=0.15, alpha = .35) +  # lines
                              # color residuals https://drsimonj.svbtle.com/visualising-residuals
            geom_point(aes(color = abs(residuals), size = abs(residuals))) +                # residuals
            scale_size(range=c(0.1,0.9)) + 
            scale_color_gradient2(low = "grey", mid = "#1ebecd", high = "orange")  +   
            guides( size = FALSE) +
       
            geom_point(aes(y = predicted), shape = 20, size=0.25)     +    # plot predicted circles
       
                stat_regline_equation(label.x=100, label.y=450, aes(label = ..eq.label..), size=2.1, 
                                      label.x.npc = "right",
                                      label.y.npc = "bottom") +   # y = mx+b and r2 values added to plot
       
                stat_regline_equation(label.x=100, label.y = 350,  aes(label = ..rr.label..), size=2.1,
                                      label.x.npc = "right",
                                      label.y.npc = "bottom") +  # r square value
       
                stat_cor( aes(label = paste(
                      if_else(readr::parse_number(..p.label..) < 0.001,    # p value
                              "p<0.001", ..p.label..), sep = "~`,   `~")),
                               label.x=100,
                               label.y = 250, size=2.1,
                               label.x.npc = "right",
                               label.y.npc = "bottom")  +
                geom_text(size=2.0, aes(x=20,y=1140,label= paste0("n=",n)))  +
                
                facet_grid( facet ~ SPECIMEN_SEX_DESC) +   # facet wrap
       
                theme(legend.position=c(0.87,0.56),legend.key.size = unit(1.4, 'mm'),    # legend position
                      legend.text=element_text(size=6), legend.title = element_text(size=6)) +
                theme(legend.box = 'horizontal')  + 
                labs(color="residuals") + 
                      theme(strip.text.x = element_text(size=7),
                      strip.text.y = element_text(size=7),
                      strip.background = element_rect(size=0.25,colour="black", fill="lightgray")) +
                      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.25)) +
                      theme(axis.title.y = element_text(size = 7), axis.title.x = element_text(size = 7) ) +
                      theme(axis.text = element_text(size = 6)) +
                      theme(panel.background = element_rect(fill = "white",
                                colour = "white",
                                size = 0.35, linetype = "solid"),  # control the grey lines
                                panel.grid.major = element_line(size = 0.125, linetype = 'solid',
                                colour = "grey"), 
                                panel.grid.minor = element_line(size = 0.125, linetype = 'solid',
                                colour = "grey"))

     while (!is.null(dev.list()))  dev.off()
     img <-   paste('C:/github/sablehead/figures/figure3.png',sep="")   # -- retrieve png 
              knitr::include_graphics(img)
     
```
(ref:figure4) Concordance between the science technician sex determinations and the genetics lab results for the 129 successful Sablefish DNA samples.  Bubble size indicates the number of specimens and fork length measurements are in mm.  Bubbles outlined in red denotes fork length ranges with the lowest concordance.

```{r figure4, fig.cap='(ref:figure4)', results='asis',  out.width = "500px", fig.align='left'}

  png("C:/github/sablehead/figures/Figure4.png", units="px", 
       width=1900, height=900, res=500) # write png to file

    # sex-DNA from research study 2016
    #sex.DNA  <-    paste("select * from Head_DNA_Report_vw", sep="")
    #science.sex.DNA <-    GetSQLData(sex.DNA,"Sablefish")      # head details from SQL Server

    #write.table(science.sex.DNA , file = paste(path,"Figure4_science_sex_DNA2022.csv",sep=''),
    #row.names=FALSE, na="",col.names=TRUE,  sep=",")

    library(pander)

    DNA.science.2022  <- read.csv(paste(path,'Figure4_science_sex_DNA2022.csv', sep=''), header=T)
    DNA.science.2022$Fork_Length <- as.numeric(DNA.science.2022$Fork_Length)

    DNA.science.table <- DNA.science.2022 %>%
       mutate(x = case_when(
       Fork_Length > 300.0 & Fork_Length <= 325.0~ "300-325",
       Fork_Length > 325.0 & Fork_Length <= 350.0~ "325-350",
       Fork_Length > 350.0 & Fork_Length <= 375.0~ "350-375",
       Fork_Length > 375.0 & Fork_Length <= 400.0~ "375-400",
       Fork_Length > 400.0 & Fork_Length <= 425.0~ "400-425",
       Fork_Length > 425.0 & Fork_Length <= 450.0~ "425-450",
       Fork_Length > 450.0 & Fork_Length <= 475.0~ "450-475",       
       Fork_Length > 475.0 & Fork_Length <= 500.0~ "475-500",
       Fork_Length > 500.0 & Fork_Length <= 525.0~ "500-525",       
       Fork_Length > 525.0 & Fork_Length <= 550.0~ "525-550",
       Fork_Length > 550.0 & Fork_Length <= 575.0~ "550-575", 
       Fork_Length > 575.0 & Fork_Length <= 600.0~ "575-600", 
       Fork_Length > 600.0 & Fork_Length <= 625.0~ "600-625",
       Fork_Length > 625.0 & Fork_Length <= 650.0~ "625-650",
       Fork_Length > 650.0 & Fork_Length <= 675.0~ "650-675",       
       Fork_Length > 675.0 & Fork_Length <= 700.0~ "675-700",
       Fork_Length > 700.0 & Fork_Length <= 725.0~ "700-725",
       Fork_Length > 725.0 & Fork_Length <= 750.0~ "725-750",       
       Fork_Length > 750.0 & Fork_Length <= 775.0~ "750-775", 
       Fork_Length > 775.0 & Fork_Length <= 800.0~ "775-800",
       Fork_Length > 800.0 & Fork_Length <= 825.0~ "800-825",
       Fork_Length > 825.0 & Fork_Length <= 850.0~ "825-850",       
       Fork_Length > 850.0 & Fork_Length <= 875.0~ "850-875",       
       Fork_Length > 875.0 & Fork_Length <= 900.0~ "875-900", 
       Fork_Length > 900.0 & Fork_Length <= 925.0~ "900-925",               
       Fork_Length > 925.0 & Fork_Length <= 950.0~ "925-950",               
       Fork_Length > 950.0 & Fork_Length <= 975.0~ "950-975",               
       Fork_Length > 975.0 & Fork_Length <= 1000.0~"975-1000"))

       agg.dna.scien <-  aggregate(DNA.science.table$DNAvial, by=list(DNA.science.table$x,
                                                           DNA.science.table$concordance), FUN=length)
       names(agg.dna.scien)  <- c("x","concordance","y")
       
       #no.concord.scien <-  agg.dna.scien[agg.dna.scien$concordance == 0,]
       #write.table(no.concord.scien, file = paste(path,'Figure4_no_concord_scien.csv',sep=''),
       #            row.names=FALSE, na="",col.names=TRUE,  sep=",") 
       no.concord.scien.file  <-  read.csv(paste(path,'Figure4_no_concord_scien.csv',sep=''),header=T)
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("300-325", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("325-350", 0, 0))       
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("400-425", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("475-500", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("525-550", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("575-600", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("675-700", 0, 0))  
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("700-725", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("725-750", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("750-775", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("775-800", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("800-825", 0, 0))       
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("825-850", 0, 0))       
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("850-875", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("875-900", 0, 0))       
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("900-925", 0, 0))       
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("925-950", 0, 0))
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("950-975", 0, 0))       
       no.concord.scien.file  <-  rbind(no.concord.scien.file, c("975-1000", 0, 0))
       
       new.no.concord.scien.file  <-  no.concord.scien.file[order(no.concord.scien.file$x),]
      
       #concord.scien <- as.data.frame(agg.dna.scien[agg.dna.scien$concordance == 1,])
       #write.table(concord.scien, file = paste(path,'Figure4_concord_scien.csv',sep=''), 
       #            row.names=FALSE, na="",col.names=TRUE,  sep=",") 
       concord.scien.file  <-  read.csv(paste(path,'Figure4_concord_scien.csv',sep=''),header=T)
       
       df_merge.scien  <-  full_join(concord.scien.file, new.no.concord.scien.file, by = "x")
       df_merge.scien[is.na(df_merge.scien)] <- 0
       df_merge.scien$count  <-  as.numeric(df_merge.scien$y.x) + as.numeric(df_merge.scien$y.y)
       df_merge.scien$percent <- round(as.numeric(df_merge.scien$y.x)/df_merge.scien$count * 100.0,1)
       df_merge.scien2  <-  df_merge.scien[order(df_merge.scien$x),]
      
       
      #  Created a table for viewing the data 
      library(data.table)   # for transpose function
      new_merge.scien <- df_merge.scien2[c(1,3,5,7)]
      ball.stick.scien<- transpose(new_merge.scien)
     
      names(ball.stick.scien) <- c("300- 325", "325- 350", "350-375" , "375- 400", "400- 425",
                                   "425- 450", "450- 475", "475- 500", "500- 525",
                                   "525- 550", "550- 575", "575- 600", "600- 625",
                                   "625- 650", "650- 675", "675- 700", "700- 725", 
                                   "725- 750", "750- 775", "775- 800", "800- 825",
                                   "825- 850", "850- 875", "875- 900", "900- 925",
                                   "925- 950", "950- 975", "975-1000")
      new.ball.stick.scien <- as.data.frame(ball.stick.scien)
      new.ball.stick.scien <- new.ball.stick.scien[-1, ]
      new.ball.stick.scien$mm <-  c("# Concordant","# Non Concordant","%")
      new.ball.stick.scien <- new.ball.stick.scien[c(29,1:28)] 
      
 
      p<-ggplot(df_merge.scien2, aes(x=x, y=percent, size = count)) +  #balls
         geom_segment( aes(x=x, xend=x, y=0, yend=percent),size = 0.2) +  #sticks
         geom_point(# put red line around the 60 %
                    color= ifelse(df_merge.scien2$percent %in% c(0,60), "red", "#5ab4ac" ), 
                    fill = alpha("#5ab4ac", 0.3), 
                    alpha= 0.7, shape=21, stroke=0.5) + 
         scale_size(range = c(.1, 4), name="Count") +
         ylim(0,110) + theme_bw() 
        
      p +  theme(text = element_text(size = 6)) +
           theme(axis.text.x = element_text(angle = 90)) + 
           ylab("%") + 
           xlab("Fork Length (mm)") +
           theme(panel.background = element_rect(fill = "white", colour = "white",
                   size = 0.35, linetype = "solid"),  # control the panel grey lines
                   panel.grid.major = element_line(size = 0.125, linetype = 'solid',
                   colour = "white"), 
                   panel.grid.minor = element_line(size = 0.125, linetype = 'solid',
                   colour = "white"))
      
      while (!is.null(dev.list()))  dev.off()
      img <-   paste('C:/github/sablehead/figures/figure4.png',sep="")   # -- retrieve png 
               knitr::include_graphics(img)
 
  
``` 

(ref:figure5) Concordance between the fishery pilot sex determinations and the genetics lab results for the 80 successful Sablefish DNA samples.  Bubble size indicates number of specimens.  Interorbial distance measurements (mm) are presented as average of three measurements. Bubbles outlined in red denotes the average interorbital distance range with the lowest concordance > 1%.

```{r figure5, fig.cap='(ref:figure5)', results='asis',  out.width = "500px", fig.align='left'}

  png("C:/github/sablehead/figures/Figure5.png", units="px", 
       width=1700, height=700, res=500) # write png to file

  DNA.fisher.2022  <- read.csv(paste(path,'Figure5_DNAfisher2022.csv', sep=''), header=T)
  names(DNA.fisher.2022) <- c("DNAvial","fisher_sex","DNALab_sex","concordance","averageInterODistance")   
  DNA.fisher.2022  <-  DNA.fisher.2022[DNA.fisher.2022$DNALab_sex != 'Unknown',]

  DNA.fisher.table <- DNA.fisher.2022 %>%
       mutate(x = case_when(
       averageInterODistance >= 35 & averageInterODistance < 37~ "35-36", 
       averageInterODistance >= 37 & averageInterODistance < 39~ "37-38",
       averageInterODistance >= 39 & averageInterODistance < 41~ "39-40",       
       averageInterODistance >= 41 & averageInterODistance < 43~ "41-42",
       averageInterODistance >= 43 & averageInterODistance < 45~ "43-44",       
       averageInterODistance >= 45 & averageInterODistance < 47~ "45-46",
       averageInterODistance >= 47 & averageInterODistance < 49~ "47-48",
       averageInterODistance >= 49 & averageInterODistance < 51~ "49-50",
       averageInterODistance >= 51 & averageInterODistance < 53~ "51-52", 
       averageInterODistance >= 53 & averageInterODistance < 55~ "53-54",
       averageInterODistance >= 55 & averageInterODistance < 57~ "55-56",
       averageInterODistance >= 57 & averageInterODistance < 59~ "57-58", 
       averageInterODistance >= 59 & averageInterODistance < 61~ "59-60",        
       averageInterODistance >= 61 & averageInterODistance < 63~ "61-62"))
  
       agg.dna <-  aggregate(DNA.fisher.table$DNAvial, by=list(DNA.fisher.table$x,
                                                           DNA.fisher.table$concordance), FUN=length)
       names(agg.dna)  <- c("x","concordance","y")
       
      #no.concord<-  agg.dna[agg.dna$concordance == 0,]
      #write.table(no.concord, file = paste(path,'Figure5_no.concord.csv',sep=''),
       #row.names=FALSE, na="",col.names=TRUE,  sep=",") 
      no.concord.file  <-  read.csv(paste(path,'Figure5_no.concord.csv',sep=''),header=T)
      
      #concord<-as.data.frame(agg.dna[agg.dna$concordance == 1,])
      #write.table(concord, file = paste(path,'Figure5_concord.csv',sep=''),
      #row.names=FALSE, na="",col.names=TRUE,  sep=",") 
      concord.file  <-  read.csv(paste(path,'Figure5_concord.csv',sep=''),header=T)
      concord.file  <-  rbind(concord.file, c("35-36", 0, 0))
      #concord.file

      df_merge  <-  full_join(concord.file,no.concord.file, by = "x")
      df_merge[is.na(df_merge)] <- 0
      df_merge$count  <-  as.numeric(df_merge$y.x) + as.numeric(df_merge$y.y)
      df_merge$percent <- round(as.numeric(df_merge$y.x)/df_merge$count * 100,1)
      
      p<-ggplot(df_merge, aes(x=x, y=percent, size=count)) +
         geom_segment( aes(x=x, xend=x, y=0, yend=percent),size = 0.2) +
         geom_point(color=ifelse(df_merge$percent %in% c(70.6), 
                                                  "red", "light blue" ), 
                    fill=alpha("light blue", 0.3), 
                    alpha=0.7, shape=21, stroke=0.5) +
                    guides(color = guide_legend(override.aes = list(size = 3),
                                                title= "Count")  ) +
        scale_size(range = c(.1, 4), name = "Count") +
        ylim(0,110) + theme_bw() 
      
        p +  theme(text = element_text(size = 6)) +
             #geom_hline(yintercept=0)  +
             theme(axis.text.x = element_text(angle = 90)) + ylab("%") + 
             xlab("Interorbital Length (mm)")  +
             theme(panel.background = element_rect(fill = "white",
                         colour = "white",
                         size = 0.35, linetype = "solid"),  # control the grey lines
                         panel.grid.major = element_line(size = 0.125, linetype = 'solid',
                         colour = "white"), 
                         panel.grid.minor = element_line(size = 0.125, linetype = 'solid',
                         colour = "white"))
      
      library(data.table)   # for transpose function
      new_merge <- df_merge[c(1,3,5,7)]
      ball.stick<- transpose(new_merge)
     
      names(ball.stick) <- c("37- 38", "39- 40", "41- 42", "43- 44", 
                             "45- 46", "47- 48", "49- 50", "51- 52", 
                             "53- 54", "55- 56", "57- 58", "59- 60", "61- 62")
      new.ball.stick <- as.data.frame(ball.stick)
      new.ball.stick <- new.ball.stick[-1, ]
      new.ball.stick$mm <-  c("# Concordant","# Non Concordant","%")
      new.ball.stick <- new.ball.stick[c(14,1:13)] 

     while (!is.null(dev.list()))  dev.off()
     img <-   paste('C:/github/sablehead/figures/figure5.png',sep="")   # -- retrieve png 
              knitr::include_graphics(img)
```             
              
\clearpage
